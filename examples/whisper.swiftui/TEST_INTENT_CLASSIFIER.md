#!/bin/bash
# Test Script for Swift Intent Classifier

echo "ðŸ§ª Testing Swift Intent Classifier Implementation"
echo "================================================"

echo ""
echo "ðŸ“‹ Key Changes Made:"
echo "âœ… Updated tokenization to match Python: tokenizer(text, maxLength=256, padding='max_length', truncation=True)"
echo "âœ… Fixed label mapping to handle both label_to_intent and intent_to_label"
echo "âœ… Updated softmax to match Python: np.exp(logits) / np.sum(np.exp(logits))"
echo "âœ… Added proper logging to match Python test output format"
echo "âœ… Enhanced model loading logs with input/output shapes"

echo ""
echo "ðŸ”§ Expected Workflow:"
echo "1. Load label_encoder.json (should show classes and mappings)"
echo "2. Load AutoTokenizer from './tokenizer' directory"
echo "3. Load intent_classifier.tflite model"
echo "4. For each prediction:"
echo "   - Tokenize text with max_length=256, padding='max_length'"
echo "   - Run TFLite inference: input_ids + attention_mask â†’ logits"
echo "   - Apply softmax: probabilities = exp(logits) / sum(exp(logits))"
echo "   - Get prediction: argmax(probabilities) and map to intent"

echo ""
echo "ðŸ“ Required Files Structure:"
echo "Resources/"
echo "â”œâ”€â”€ intent_classifier.tflite"
echo "â”œâ”€â”€ label_encoder.json"
echo "â””â”€â”€ tokenizer/"
echo "    â”œâ”€â”€ tokenizer.json"
echo "    â”œâ”€â”€ tokenizer_config.json"
echo "    â””â”€â”€ vocab.txt"

echo ""
echo "ðŸ› Common Issues to Check:"
echo "1. Bundle resource loading - verify files are included in Xcode target"
echo "2. Swift Transformers import - ensure package is properly linked"
echo "3. Tokenization parameters - must match Python exactly"
echo "4. Input tensor shapes - verify [1, 256] for both input_ids and attention_mask"
echo "5. Output tensor shape - should be [1, 13] for 13 intent classes"

echo ""
echo "âœ¨ Test Commands in Xcode Console:"
echo "po await intentClassifier.initialize()"
echo "po await intentClassifier.classifyIntent(\"what is my heart rate\")"
echo "po intentClassifier.getIntentList()"

echo ""
echo "ðŸŽ¯ Expected Output Format:"
echo "âœ“ Label encoder loaded from JSON"
echo "  Total classes: 13"
echo "  Classes: QueryPoint, SetGoal, SetThreshold, ..."
echo "âœ“ BERT tokenizer loaded from [path]"
echo "  Max sequence length: 256"
echo "âœ“ Complete TFLite model loaded successfully!"
echo "  Input 0: Shape: [1, 256]"
echo "  Input 1: Shape: [1, 256]"
echo "  Output 0: Shape: [1, 13]"
echo "This is a single end-to-end model: Text â†’ Intent"

echo ""
echo "For text 'what is my heart rate':"
echo "Tokenized 'what is my heart rate' -> X tokens (seq_len=256)"
echo "Input IDs: [101, 2054, 2003, 2026, 2540, 3954, 102, ...]"
echo "Attention: [1, 1, 1, 1, 1, 1, 1, ...]"
echo "Model logits: [0.123, -1.456, 2.789, ...] (13 classes)"
echo "Prediction: QueryPoint (label: 0)"
echo "Confidence: 0.8945"

echo ""
echo "ðŸ“Š If you see these logs, the implementation should work!"