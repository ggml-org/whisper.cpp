name: Ryzen AI Minimal Build

on:
  workflow_dispatch:
    inputs:
      runson:
        description: 'Which runner group to run the workflow on'
        default: 'stx'
        required: true
        type: choice
        options:
          - 'rai300_400'
          - 'stx'
          - 'stx-halo'
          - 'stx-test'

jobs:
  build-ryzenai:
    runs-on: ${{ github.event.inputs.runson }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2

      - name: Download FlexML Runtime
        shell: pwsh
        run: |
          Write-Host "Downloading FlexML Runtime..."
          Invoke-WebRequest -Uri "https://github.com/lemonade-sdk/whisper.cpp/releases/download/deps/flexmlrt1.7.0rc.zip" -OutFile flexmlrt.zip
          Write-Host "Download complete"

      - name: Extract FlexML Runtime
        shell: pwsh
        run: |
          Write-Host "Extracting FlexML Runtime..."
          tar xvf flexmlrt.zip
          Write-Host "Extraction complete"
          
          # List what was extracted
          Get-ChildItem -Directory | Where-Object { $_.Name -like "flexmlrt*" }

      - name: Setup FlexML Runtime environment
        shell: cmd
        run: |
          echo "Setting up FlexML environment..."
          cd flexmlrt
          call setup.bat
          echo "Setup complete"

      - name: Configure CMake with VitisAI
        shell: pwsh
        run: |
          Write-Host "Configuring CMake..."
          cmake -B build -A x64 -DCMAKE_BUILD_TYPE=Release -DWHISPER_VITISAI=ON

      - name: Build
        shell: pwsh
        run: |
          Write-Host "Building..."
          cmake --build build --config Release -j
          Write-Host "Build complete"

      - name: List build output
        shell: pwsh
        run: |
          Write-Host "Build output contents:"
          Get-ChildItem -Path "build/bin/Release" -Recurse | Format-Table Name, Length

      - name: Copy FlexML Runtime DLLs to build output
        shell: pwsh
        run: |
          Write-Host "Copying FlexML Runtime DLLs..."
          
          if (Test-Path "flexmlrt/bin") {
            Copy-Item -Path "flexmlrt/bin/*.dll" -Destination "build/bin/Release/" -Force -ErrorAction SilentlyContinue
          }
          
          if (Test-Path "flexmlrt/lib") {
            Copy-Item -Path "flexmlrt/lib/*.dll" -Destination "build/bin/Release/" -Force -ErrorAction SilentlyContinue
          }
          
          Write-Host "DLLs copied"

      - name: Package binaries
        shell: pwsh
        run: |
          Write-Host "Creating ZIP package..."
          Compress-Archive -Path "build/bin/Release/*" -DestinationPath "whisper-ryzenai-minimal.zip"
          Write-Host "Package created"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-ryzenai-minimal
          path: whisper-ryzenai-minimal.zip
          
      - name: Build Summary
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "Build completed successfully!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Artifact: whisper-ryzenai-minimal.zip"
          Write-Host "Download from: Actions > This workflow run > Artifacts"
