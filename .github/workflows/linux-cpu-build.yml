name: Linux CPU Build

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'ggml/**'
      - 'CMakeLists.txt'
      - '**.cmake'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'src/**'
      - 'ggml/**'
      - 'CMakeLists.txt'
      - '**.cmake'
  workflow_dispatch:
  release:
    types: [created]

jobs:
  build-cpu-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          echo "Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            git \
            libsdl2-dev \
            pkg-config
          echo "Dependencies installed"
          cmake --version
          gcc --version

      - name: Configure CMake
        run: |
          echo "Configuring CMake..."
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DWHISPER_BUILD_EXAMPLES=ON \
            -DWHISPER_BUILD_TESTS=OFF \
            -DWHISPER_BUILD_SERVER=ON
          if [ $? -ne 0 ]; then
            echo "ERROR: CMake configuration failed!"
            exit 1
          fi
          echo "Configuration complete"

      - name: Build
        run: |
          echo "Building..."
          cmake --build build --config Release -j$(nproc)
          if [ $? -ne 0 ]; then
            echo "ERROR: Build failed!"
            exit 1
          fi
          echo "Build complete"

      - name: List build output
        run: |
          echo "Build output contents:"
          if [ -d "build/bin" ]; then
            find build/bin -type f -executable -o -name "*.so*" | while read file; do
              ls -lh "$file"
            done
            echo ""
            echo "All build artifacts:"
            find build/bin -type f | sort
            echo ""
            echo "Checking library dependencies for whisper-server:"
            if [ -f "build/bin/whisper-server" ]; then
              ldd build/bin/whisper-server || echo "Note: ldd may show missing libs if statically linked"
            fi
          else
            echo "ERROR: build/bin directory not found!"
            exit 1
          fi

      - name: Package binaries
        run: |
          echo "Creating package..."
          
          # Create package directory
          PACKAGE_NAME="whisper-cpu-linux-$(uname -m)"
          PACKAGE_DIR="$PACKAGE_NAME"
          mkdir -p "$PACKAGE_DIR"
          
          # Copy binaries and libraries from build/bin
          if [ -d "build/bin" ]; then
            # Copy all files from build/bin
            cp -r build/bin/* "$PACKAGE_DIR/" 2>/dev/null || true
            
            # Also find and copy .so files from build directory (they might be in lib/)
            find build -name "*.so*" -type f -exec cp {} "$PACKAGE_DIR/" \; 2>/dev/null || true
          fi
          
          # Verify whisper-server exists
          if [ ! -f "$PACKAGE_DIR/whisper-server" ]; then
            echo "ERROR: whisper-server not found in package!"
            echo "Contents of package directory:"
            ls -la "$PACKAGE_DIR"
            exit 1
          fi
          
          # Check dependencies
          echo "Checking whisper-server dependencies:"
          ldd "$PACKAGE_DIR/whisper-server" || echo "Note: May be statically linked or missing system libs"
          
          # Make whisper-server executable
          chmod +x "$PACKAGE_DIR/whisper-server"
          
          # Create a run script that sets LD_LIBRARY_PATH
          {
            printf "#!/bin/bash\n"
            printf "# Run whisper-server with proper library path\n"
            printf "SCRIPT_DIR=\"\$(cd \"\$(dirname \"\${BASH_SOURCE[0]}\")\" && pwd)\"\n"
            printf "export LD_LIBRARY_PATH=\"\${SCRIPT_DIR}:\${LD_LIBRARY_PATH}\"\n"
            printf "exec \"\${SCRIPT_DIR}/whisper-server\" \"\$@\"\n"
          } > "$PACKAGE_DIR/run-whisper-server.sh"
          chmod +x "$PACKAGE_DIR/run-whisper-server.sh"
          
          # Create README with usage instructions
          {
            printf "Whisper.cpp CPU Build for Linux\n"
            printf "===============================\n\n"
            printf "Build Date: %s\n" "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            printf "Architecture: %s\n" "$(uname -m)"
            printf "OS: %s\n" "$(uname -o)"
            printf "Kernel: %s\n\n" "$(uname -r)"
            printf "Binaries:\n"
            ls -lh "$PACKAGE_DIR" | grep -v "^total" | grep -v "^d" | awk '{print "  " $9 " (" $5 ")"}'
            printf "\n"
            printf "Usage:\n"
            printf "------\n\n"
            printf "Option 1: Use the run script (recommended):\n"
            printf "  ./run-whisper-server.sh --host 127.0.0.1 -m /path/to/model.bin\n\n"
            printf "Option 2: Set LD_LIBRARY_PATH manually:\n"
            printf "  export LD_LIBRARY_PATH=\$(pwd):\$LD_LIBRARY_PATH\n"
            printf "  ./whisper-server --host 127.0.0.1 -m /path/to/model.bin\n\n"
            printf "System Requirements:\n"
            printf "-------------------\n"
            printf "This build requires standard Linux system libraries:\n"
            printf "  - libc (glibc)\n"
            printf "  - libstdc++\n"
            printf "  - libpthread\n"
            printf "  - libm\n"
            printf "These are typically pre-installed on most Linux distributions.\n"
          } > "$PACKAGE_DIR/README.txt"
          
          # Create tarball
          tar -czf "${PACKAGE_NAME}.tar.gz" "$PACKAGE_DIR"
          
          if [ -f "${PACKAGE_NAME}.tar.gz" ]; then
            PACKAGE_SIZE=$(du -h "${PACKAGE_NAME}.tar.gz" | cut -f1)
            echo "Package created successfully: ${PACKAGE_NAME}.tar.gz ($PACKAGE_SIZE)"
            ls -lh "${PACKAGE_NAME}.tar.gz"
            echo ""
            echo "Package contents:"
            tar -tzf "${PACKAGE_NAME}.tar.gz" | head -20
          else
            echo "ERROR: Failed to create package!"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper-cpu-linux
          path: whisper-cpu-linux-*.tar.gz
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: whisper-cpu-linux-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        run: |
          echo "========================================"
          echo "Build completed successfully!"
          echo "========================================"
          echo ""
          echo "Artifact: whisper-cpu-linux-*.tar.gz"
          echo "Download from: Actions > This workflow run > Artifacts"
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "Release: Available in GitHub Releases"
          fi
